---
title: "VarDecomp"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(brms)
library(parallel)
library(tidyverse)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```


```{r function-testfunction}
testfunction = function(){

emojis = c("\U1F600", "\U1F604", "\U1F601", "\U1F643", "\U1F609", "\U1F60A", "\U1F929", "\U1F917", "\U1F92D", "\U1F973", "\U1F920", "\U1F978", "\U1F60E", "\U1F913", "\U1F47D", "\U1F638", "\U1F596", "\U1F44C", "\U270C", "\U1F44D", "\U1F44F", "\U1F64C", "\U1F40C", "\U1F41B", "\U1F41E", "\U1F997")  

print(paste("No problem", sample(emojis, size = 1)))
}
```

# brms_model: function for running brms models

```{r function-brms_model}

#' Run a brms model
#'
#' @param Data A data frame containing the data - covariates should be centered to a the mean or to a meaningful zero (see Schielzeth H. 2010. Simple means to improve the interpretability of regression coefficients. Methods Ecol Evol. 1:103â€“113. doi:10.1111/j.2041-210X.2010.00012.x.).
#' @param Response String with the name of the column in Data containing the response variable (e.g. "mass"). 
#' @param FixedEffect String with the name of the column in Data containing the fixed effect variable (e.g. "height"). To add multiple fixed effects, use c() (e.g. c("height", "sex")). 
#' @param RandomEffect String with the name of the column in Data containing the random effect variable (e.g. "species"). The current package version allows the use of a single random effect.
#' @param RandomSlope String with the name of the column in Data containing the covariate to be added as a random slope (e.g. "height"). The current package version allows the use of a single random slope.
#' @param Chainset String to define the number of iterations. Start with "test" (warmup=10; iter=110; thin=10; chains=2) and increase as needed until convergence: "long"(warmup=15000; iter=30000; thin=15; chains=2); "longer"(warmup=30000; iter=60000; thin=30; chains=2); "longest" (warmup=60000; iter=120000; thin=60; chains=2).
#' @param Family String to define the family function in the brms model. Current supported families: "gaussian", "binomial", "poisson".
#' @param Seed Numeric and optional. Set a seed in order to repeat the results from the model when running it more than once. 
#'
#' @return Returns a brmsfit
#' @export 
#'
brms_model = function(Data, Response, FixedEffect, RandomEffect = NULL, RandomSlope = NULL, Chainset, Family = "gaussian", Seed = sample(1000:9999, 1)){

  
stopifnot("`Data` must be a data frame" =               
              inherits(Data, "data.frame"))
  
stopifnot("`Response` must be a string" =               
              inherits(Response, "character"))

stopifnot("`FixedEffect` must be a string" =               
              inherits(FixedEffect, "character"))

if(!is.null(RandomEffect)) {stopifnot("`RandomEffect` must be a string" =               
              inherits(RandomEffect, "character"))}

if(!is.null(RandomSlope)){stopifnot("`RandomSlope` must be a string" =               
              inherits(RandomSlope, "character"))}

stopifnot("`Chainset` must be a string (options are 'test', 'long, 'longer', 'longest')" =               
              inherits(Chainset, "character"))

stopifnot("`Family` must be a string" =               
              inherits(Family, "character"))

stopifnot("`Seed` must be a string" =               
              inherits(Seed, "numeric"))

testfunction()
  
if(Chainset=="longest"){warmup=60000; iter=120000; thin=60; chains=2}
if(Chainset=="longer"){warmup=30000; iter=60000; thin=30; chains=2}
if(Chainset=="long"){warmup=15000; iter=30000; thin=15; chains=2}
if(Chainset=="test"){warmup=10; iter=110; thin=10; chains=2}


# Construct the formula object
  bfform = 
    
    if(is.null(RandomEffect)) {
      paste0(Response, "~", paste(FixedEffect, collapse = " + "))
      } else {
        if(is.null(RandomSlope)){
        paste0(Response, "~", paste(FixedEffect, collapse = " + "),
        "+ ( 1 | ", RandomEffect," )")
          } else {
          paste0(Response, "~",
                 paste(FixedEffect, collapse = " + "),
                 "+ ( 1 +", RandomSlope, " | ", RandomEffect," )")}}
        
    
mod =  brms::brm(brms::bf(stats::as.formula(bfform)),
                  family = Family,
                  data = Data, 
                  warmup = warmup,
                  iter = iter, 
                  thin=thin, 
                  chains = chains, 
                  init = "random", 
                  seed = Seed, 
                  cores = parallel::detectCores(), 
                  control = list(adapt_delta = 0.999), 
                  sample_prior = TRUE)

brmsfit = mod

return(brmsfit)

}

```

```{r examples-brms_model, warning=FALSE, message=FALSE}

# With random slope
md = dplyr::starwars

mod = VarDecomp::brms_model(Chainset = "long", 
           Response = "mass", 
           FixedEffect = c("sex","height"), 
           RandomEffect = "species", 
           RandomSlope = "height",
           Family = "gaussian", 
           Data = md, 
           Seed = 0405)

print(mod)

plot(mod)

```

```{r test-brms_model}

md = dplyr::starwars


# Without random effects

mod = brms_model(Chainset = "long", 
           Response = "mass", 
           FixedEffect = c("sex","height"), 
           Family = "gaussian", 
           Data = md, 
          Seed = 0405)

print(mod)

plot(mod)

# With random effect
mod_RE = brms_model(Chainset = "long", 
           Response = "mass", 
           FixedEffect = c("sex","height"), 
           RandomEffect = "species", 
           Family = "gaussian", 
           Data = md, 
           Seed = 0405)

print(mod_RE)

plot(mod_RE)


# With random slope
mod_RS = brms_model(Chainset = "long", 
           Response = "mass", 
           FixedEffect = c("sex","height"), 
           RandomEffect = "species", 
           RandomSlope = "height",
           Family = "gaussian", 
           Data = md, 
          Seed = 0405)

print(mod_RS)

plot(mod_RS)

```



________

## VarDecomp = function for variance decomposition
```{r dev}
#function-var_decomp
var_decomp = function(brmsfit){

# Extract original data
  Data = brmsfit$data
  
  Data = Data %>% 
    filter(if_all(1:ncol(Data),~ !is.na(.)))
  
  
# Extract posterior samples
  PS = as.data.frame(brmsfit) %>% 
  select(!starts_with("r")) %>% 
  select(!contains("prior")) %>% 
  select(!lp__)
 
  
### CHECK WHY THERE IS A SECOND INTERCEPT VALUE
if("Intercept" %in% colnames(PS)){PS = PS %>% select(-Intercept)}

#Extract family
Family = brmsfit$family[[1]][1]

#Extract fixed effect names
PS_b = PS %>% 
  select(starts_with("b_")) %>% 
  rename_with(~ str_remove(., "^b_")) %>%  
  select(!Intercept)

FixedEffect = colnames(PS_b)

#Extract random effect names
PS_sd = PS %>% 
  select(starts_with("sd_")) %>% 
  rename_with(~ str_remove(., "^sd_"))

PS_RE = PS_sd %>% 
  select(ends_with("Intercept")) %>% 
  rename_with(~ str_remove(., "__Intercept"))

RandomEffect = colnames(PS_RE)


#Extract random slope names

PS_RS = PS_sd %>% 
  rename_with(~ str_replace_all(., "__", "_")) %>% 
  select(!ends_with("Intercept"))
  

RandomSlope = colnames(PS_RS)


#Rename columns for tidying the data
PS = PS %>% 
  rename_with(~str_remove_all(., "^b_")) %>% 
  rename_with(~str_remove_all(., "sd_")) %>% 
  rename_with(~str_replace_all(., "__", "_")) %>% 
  rename_with(~str_remove_all(., "_Intercept")) 


# Variance in fixed effects

## Create a dataframe with the values used by the model for fixed effects
  FixedEffectData = Data %>% 
  select(c(setdiff(colnames(Data), RandomEffect))) %>% 
  select(-1)  
  
## Specific for covariates with a character input
  CharactersFE = FixedEffectData%>%
  select(-one_of(FixedEffect))
  
for(i in colnames(CharactersFE)){
unique_values = unique(CharactersFE[[i]])

for (j in unique_values) {
#  CharactersFE[[j]] = if_else(CharactersFE[[i]] == j, 1, 0)
  
  CharactersFE = CharactersFE %>% 
    mutate(!!paste(j) := if_else(CharactersFE[[i]] == j, 1,0)) %>% 
    rename(!!paste0(i, j) := paste(j)) 
  
}
CharactersFE = CharactersFE 
}

FixedEffectData = bind_cols(FixedEffectData,CharactersFE) %>% 
  select_if(~ is.numeric(.))


## Calculate estimated variances for each fixed effect

for (i in colnames(FixedEffectData)){
  if (i %in% colnames(PS)) {
        PS = PS %>% 
           mutate(!!paste0("var_", i) := get(paste0(i))*
               var(FixedEffectData[[paste0(i)]]))
  
    }}



# Calculate the estimated variances in random slope
if(RandomSlope){
  PS = PS %>% 
  mutate(!!paste0("var_", FixedEffect, RandomEffect) := (get(paste0("sd_",RandomEffect,"__", FixedEffect,"C"))^2 *
                  var(Data[[paste0(FixedEffect, "C")]])) +
                
                 (get(paste0("sd_",RandomEffect,"__", FixedEffect,"C"))^2 *
                  mean(Data[[paste0(FixedEffect, "C")]])))}
           
# Variances in random effect
PS = PS %>% 
  mutate(!!paste0("var_", RandomEffect) := 
           
           
        # for models without random slopes
          ifelse(RandomSlope == FALSE, 
                 get(paste0("sd_",RandomEffect,"__Intercept"))^2,
        
        # for models with random slope (in Holger's paper on random slopes)
                 (get(paste0("sd_",RandomEffect,"__", "Intercept"))^2) +
                  
              (get(paste0("var_", FixedEffect, RandomEffect))) +
                        
                (get(paste0("cor_", RandomEffect, "__Intercept__",
                            FixedEffect, "C"))) *
                   get(paste0("sd_",RandomEffect,"__Intercept")) *
                   get(paste0("sd_",RandomEffect,"__", FixedEffect,"C")) *
                   2 *  mean(Data[[paste0(FixedEffect, "C")]]))) %>% 
                            
# Total phenotypic variance
  mutate(residual = ifelse(Family == "gaussian", sigma^2,
                      ifelse(Family == "binomial",
                             (sd_observationID__Intercept^2 + (pi^2/3)),
                        ifelse(Family== "poisson", 
                               (sd_observationID__Intercept^2 + 
                                  log(1/exp(b_Intercept)+1)), NA)))) %>% 
  
  mutate(total_pv = 
           get(paste0("var_", FixedEffect)) + 
           get(paste0("var_", RandomEffect)) + 
           residual) %>% 



# Variance explained by each variable

    # Fixed effect
   mutate(!!paste0("R2_", FixedEffect) := 
            get(paste0("var_", FixedEffect))/total_pv,
    
    # Random effect
          !!paste0("R2_",RandomEffect) := 
             get(paste0("var_", RandomEffect))/total_pv,

    # Residual
          R2_Residual = residual/total_pv) 
   
   
    # Random slopes
    if(RandomSlope){
      
      PS = PS %>%
        mutate(!!paste0("R2_", FixedEffect, RandomEffect) := 
                   get(paste0("var_", FixedEffect, RandomEffect))/total_pv)} 
    
return(PS)
  
}

```





```{r development-inflate, eval=FALSE}
# Execute in the console directly - keep eval=FALSE to avoid infinite loop
fusen::inflate(flat_file = "dev/VarDecomp_package.Rmd", vignette_name = "Vignette")
```